<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Prayer Times</title>
  <style>
    body {
      font-family: 'Helvetica Neue', sans-serif;
      margin: 0;
      text-align: center;
      color: #fff;
      transition: background 0.3s, color 0.3s;
      background: linear-gradient(to top, #1e3c72, #2a5298); /* default fallback */
    }

    .container {
      max-width: 500px;
      margin: auto;
      padding: 20px;
    }

    h1 {
      font-weight: 300;
      font-size: 2rem;
    }

    .clock {
      font-size: 1.2rem;
      margin-top: 5px;
    }

    .dates {
      font-size: 1rem;
      margin-bottom: 10px;
    }

    .search-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    input, select {
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
    }

    button {
      padding: 10px 15px;
      background: #007aff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .card {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      margin-top: 15px;
    }

    .time-row {
      font-size: 1.1rem;
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .icon {
      margin-right: 10px;
    }

    .dropdown, .toggle-btn {
      margin-top: 10px;
    }

    .time-label {
      display: flex;
      align-items: center;
    }

  </style>
</head>
<body>
  <div class="container">
    <h1>üìø Prayer Times</h1>
    <div class="clock" id="clock">--:--:--</div>
    <div class="dates" id="dates">Loading dates...</div>

    <div class="search-bar">
      <input type="text" id="city" placeholder="City">
      <input type="text" id="country" placeholder="Country">
      <button onclick="searchLocation()">Search</button>
      <button onclick="detectLocation()">üìç Detect</button>
    </div>

    <select id="savedLocations" class="dropdown" onchange="loadSavedLocation(this.value)">
      <option value="">Saved Locations</option>
    </select>

    <div id="times" class="card">Enter a location or use detect</div>

    <button class="toggle-btn" onclick="toggleDarkMode()">üåô Toggle Dark Mode</button>
  </div>

  <script>
    const prayerIcons = {
      "Fajr": "üåÑ",
      "Sunrise": "üåÖ",
      "Dhuhr": "‚òÄÔ∏è",
      "Asr": "üåá",
      "Maghrib": "üåÜ",
      "Isha": "üåÉ"
    };

    function to12Hour(time24) {
      const [hourStr, minute] = time24.split(':');
      let hour = parseInt(hourStr);
      const ampm = hour >= 12 ? 'PM' : 'AM';
      hour = hour % 12 || 12;
      return `${hour}:${minute} ${ampm}`;
    }

    function updateClock() {
      const now = new Date();
      const clock = document.getElementById('clock');
      clock.textContent = now.toLocaleTimeString();
    }

    function updateSavedLocationsDropdown() {
      const dropdown = document.getElementById('savedLocations');
      dropdown.innerHTML = '<option value="">Saved Locations</option>';
      const saved = JSON.parse(localStorage.getItem('savedLocations') || '[]');
      saved.forEach(loc => {
        const opt = document.createElement('option');
        opt.value = JSON.stringify(loc);
        opt.textContent = `${loc.city}, ${loc.country}`;
        dropdown.appendChild(opt);
      });
    }

    function saveLocation(city, country) {
      let saved = JSON.parse(localStorage.getItem('savedLocations') || '[]');
      if (!saved.some(loc => loc.city === city && loc.country === country)) {
        saved.push({ city, country });
        localStorage.setItem('savedLocations', JSON.stringify(saved));
        updateSavedLocationsDropdown();
      }
    }

    function fetchPrayerTimes(city, country) {
      const method = 2;
      const url = `https://api.aladhan.com/v1/timingsByCity?city=${city}&country=${country}&method=${method}&school=1`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          const times = data.data.timings;
          const hijri = data.data.date.hijri;
          const gregorian = data.data.date.gregorian;
          document.getElementById('dates').innerHTML = `${gregorian.date} | ${hijri.date} (${hijri.weekday.en})`;

          const timesDiv = document.getElementById('times');
          timesDiv.innerHTML = `<h2>${city}, ${country}</h2>`;
          const keys = ["Fajr", "Sunrise", "Dhuhr", "Asr", "Maghrib", "Isha"];
          keys.forEach(key => {
            const row = document.createElement('div');
            row.className = 'time-row';
            row.innerHTML = `<span class="time-label"><span class="icon">${prayerIcons[key]}</span>${key}</span><span>${to12Hour(times[key])}</span>`;
            timesDiv.appendChild(row);
          });

          updateBackground(keys, times);
        })
        .catch(err => {
          document.getElementById('times').innerHTML = 'Failed to fetch prayer times.';
          console.error(err);
        });
    }

    function updateBackground(prayers, times) {
      const now = new Date();
      const currentTime = now.getHours() * 60 + now.getMinutes();

      let activePrayer = prayers[0];
      for (let i = 0; i < prayers.length; i++) {
        const [h, m] = times[prayers[i]].split(':').map(Number);
        const mins = h * 60 + m;
        if (currentTime >= mins) {
          activePrayer = prayers[i];
        }
      }

      const gradients = {
        "Fajr": "#1e3c72, #2a5298",
        "Sunrise": "#f6d365, #fda085",
        "Dhuhr": "#56ccf2, #2f80ed",
        "Asr": "#f2994a, #f2c94c",
        "Maghrib": "#e96443, #904e95",
        "Isha": "#141e30, #243b55"
      };

      document.body.style.background = `linear-gradient(to top, ${gradients[activePrayer]})`;
    }

    function searchLocation() {
      const city = document.getElementById('city').value.trim();
      const country = document.getElementById('country').value.trim();
      if (!city || !country) return alert('Enter both city and country');
      saveLocation(city, country);
      fetchPrayerTimes(city, country);
    }

    function loadSavedLocation(val) {
      if (!val) return;
      const { city, country } = JSON.parse(val);
      fetchPrayerTimes(city, country);
    }

    function detectLocation() {
      if (!navigator.geolocation) return alert('Geolocation not supported');
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=en`)
          .then(res => res.json())
          .then(data => {
            const city = data.city || data.locality || data.principalSubdivision || "Unknown";
            const country = data.countryCode || "US";
            document.getElementById('city').value = city;
            document.getElementById('country').value = country;
            fetchPrayerTimes(city, country);
            saveLocation(city, country);
          })
          .catch(err => console.error('Failed to detect location:', err));
      });
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
    }

    setInterval(updateClock, 1000);
    updateClock();
    updateSavedLocationsDropdown();
  </script>
</body>
</html>
