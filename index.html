<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prayer Times</title>
  <style>
    :root {
      --bg-color: linear-gradient(to top, #1e3c72, #2a5298);
      --card-bg: rgba(255,255,255,0.1);
      --text-color: #fff;
      --button-bg: #007aff;
      --tab-bg: rgba(255,255,255,0.2);
      --tab-active-bg: rgba(255,255,255,0.4);
      --next-prayer-bg: rgba(255,255,255,0.2);
      --input-bg: rgba(255,255,255,0.9);
      --input-text: #333;
    }

    .dark-mode {
      --bg-color: linear-gradient(to top, #2d2d2d, #1a1a1a);
      --card-bg: rgba(0,0,0,0.4);
      --text-color: #f0f0f0;
      --button-bg: #1a73e8;
      --tab-bg: rgba(0,0,0,0.4);
      --tab-active-bg: rgba(0,0,0,0.6);
      --next-prayer-bg: rgba(0,0,0,0.4);
      --input-bg: rgba(255,255,255,0.15);
      --input-text: #fff;
    }

    body {
      font-family: 'Helvetica Neue', sans-serif;
      margin: 0;
      text-align: center;
      color: var(--text-color);
      transition: all 0.3s ease;
      background: var(--bg-color);
      min-height: 100vh;
    }

    .container { max-width: 500px; margin: auto; padding: 20px; }
    h1 { font-weight: 300; font-size: 2rem; margin-bottom: 5px; }
    .clock { font-size: 1.2rem; margin-top: 5px; }
    .dates { font-size: 1rem; margin-bottom: 10px; opacity: 0.9; }
    .search-bar { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 10px; }
    input, select { 
      padding: 10px; 
      border-radius: 8px; 
      border: none; 
      font-size: 1rem; 
      background: var(--input-bg);
      color: var(--input-text);
    }
    button { 
      padding: 10px 15px; 
      background: var(--button-bg); 
      color: white; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      transition: transform 0.2s, opacity 0.2s;
    }
    button:hover { opacity: 0.9; transform: scale(1.02); }
    button:active { transform: scale(0.98); }
    .card { 
      background: var(--card-bg); 
      backdrop-filter: blur(10px); 
      padding: 20px; 
      border-radius: 16px; 
      box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
      margin-top: 15px; 
    }
    .time-row { 
      font-size: 1.1rem; 
      margin: 10px 0; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
    }
    .icon { margin-right: 10px; }
    .dropdown { margin-top: 10px; }
    .time-label { display: flex; align-items: center; }
    .tab-container { 
      display: flex; 
      justify-content: center; 
      margin-bottom: 15px;
      background: var(--tab-bg);
      border-radius: 8px;
      padding: 5px;
    }
    .tab { 
      padding: 10px 20px; 
      background: transparent; 
      border: none; 
      color: var(--text-color); 
      cursor: pointer; 
      border-radius: 5px;
      transition: all 0.3s;
    }
    .tab.active { 
      background: var(--tab-active-bg);
      font-weight: bold;
    }
    
    /* Enhanced Compass Styles */
    .compass-container {
      position: relative;
      width: 250px;
      height: 250px;
      margin: 20px auto;
    }
    .compass {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 2px solid var(--text-color);
      position: relative;
      background: rgba(0,0,0,0.1);
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }
    .compass-rose {
      position: absolute;
      width: 100%;
      height: 100%;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><circle cx="100" cy="100" r="95" fill="none" stroke="%23ffffff50" stroke-width="2"/><line x1="100" y1="10" x2="100" y2="30" stroke="%23ffffff" stroke-width="2"/><line x1="100" y1="170" x2="100" y2="190" stroke="%23ffffff" stroke-width="2"/><line x1="10" y1="100" x2="30" y2="100" stroke="%23ffffff" stroke-width="2"/><line x1="170" y1="100" x2="190" y2="100" stroke="%23ffffff" stroke-width="2"/><text x="100" y="40" fill="%23ffffff" text-anchor="middle" font-size="14">N</text><text x="100" y="185" fill="%23ffffff" text-anchor="middle" font-size="14">S</text><text x="30" y="110" fill="%23ffffff" text-anchor="middle" font-size="14">W</text><text x="170" y="110" fill="%23ffffff" text-anchor="middle" font-size="14">E</text></svg>');
      background-size: contain;
    }
    .compass-arrow {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 80%;
      height: 4px;
      background: linear-gradient(to right, transparent 10%, #ff3b30 50%, transparent 90%);
      transform-origin: left center;
      z-index: 2;
    }
    .compass-center {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 12px;
      height: 12px;
      background: #fff;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 3;
    }
    .kaaba-marker {
      position: absolute;
      width: 30px;
      height: 30px;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23FF3B30"><path d="M12 2L4 7v10l8 5 8-5V7l-8-5zm0 2.3L18.5 9l-6.5 3.7L5.5 9 12 4.3zm-7 5.3l6 3.4v6.6l-6-3.4V9.6zm14 0v6.6l-6 3.4v-6.6l6-3.4z"/></svg>');
      background-size: contain;
      transform: translate(-50%, -50%);
      z-index: 4;
    }
    
    .hidden { display: none; }
    .settings { text-align: left; margin-top: 15px; }
    .next-prayer { 
      font-weight: bold; 
      margin-top: 10px; 
      padding: 10px; 
      background: var(--next-prayer-bg); 
      border-radius: 8px;
    }
    .save-btn { 
      margin-top: 20px; 
      width: 100%; 
      font-weight: bold;
      background: #34C759 !important;
    }
    .settings-option {
      display: flex;
      align-items: center;
      padding: 8px 0;
    }
    .settings-option input { margin-right: 10px; }
    .kaaba-label { color: #FF3B30; font-weight: bold; }
    .user-label { color: #34C759; font-weight: bold; }
    .distance-info { margin-top: 10px; font-size: 0.9rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìø Prayer Times</h1>
    <div class="clock" id="clock">--:--:--</div>
    <div class="dates" id="dates">Loading dates...</div>

    <div class="tab-container">
      <button class="tab active" onclick="showTab('prayer-times')">Prayer Times</button>
      <button class="tab" onclick="showTab('qibla')">Qibla Direction</button>
      <button class="tab" onclick="showTab('settings')">Settings</button>
    </div>

    <div id="prayer-times-tab">
      <div class="search-bar">
        <input type="text" id="city" placeholder="City">
        <input type="text" id="country" placeholder="Country">
        <button onclick="searchLocation()">Search</button>
        <button onclick="detectLocation()">üìç Detect</button>
      </div>

      <select id="savedLocations" class="dropdown" onchange="loadSavedLocation(this.value)">
        <option value="">Saved Locations</option>
      </select>

      <div id="times" class="card">Enter a location or use detect</div>
      <div id="next-prayer" class="next-prayer"></div>
    </div>

    <div id="qibla-tab" class="hidden">
      <div class="compass-container">
        <div class="compass">
          <div class="compass-rose"></div>
          <div class="compass-arrow" id="compass-arrow"></div>
          <div class="compass-center"></div>
          <div class="kaaba-marker" id="kaaba-marker"></div>
        </div>
      </div>
      <div id="qibla-info" class="card">
        <h2>Qibla Direction</h2>
        <p><span class="user-label">You are in:</span> <span id="current-location">Unknown</span></p>
        <p>Facing: <span id="qibla-degrees">0¬∞</span> from North</p>
        <p><span class="kaaba-label">Toward Kaaba in Mecca</span></p>
      </div>
      <div id="distance-info" class="distance-info">Distance: calculating...</div>
    </div>

    <div id="settings-tab" class="hidden">
      <div class="card settings">
        <h3>Settings</h3>
        <div class="settings-option">
          <input type="radio" id="standard-asr" name="asr-method" value="standard" checked>
          <label for="standard-asr">Standard Asr</label>
        </div>
        <div class="settings-option">
          <input type="radio" id="hanafi-asr" name="asr-method" value="hanafi">
          <label for="hanafi-asr">Hanafi Asr</label>
        </div>
        <div class="settings-option">
          <input type="checkbox" id="dark-mode-toggle">
          <label for="dark-mode-toggle">Dark Mode</label>
        </div>
        <button class="save-btn" onclick="saveSettings()">üíæ Save Settings</button>
      </div>
    </div>
  </div>

  <script>
    // Constants
    const KAABA_LAT = 21.3891;
    const KAABA_LNG = 39.8579;
    const prayerIcons = {
      "Fajr": "üåÑ", "Sunrise": "üåÖ", "Dhuhr": "‚òÄÔ∏è", 
      "Asr": "üåá", "Maghrib": "üåÜ", "Isha": "üåÉ"
    };

    // State
    let currentLocation = {};
    let currentQiblaDirection = 0;
    let distanceToKaaba = 0;

    // DOM Elements
    const clockEl = document.getElementById('clock');
    const datesEl = document.getElementById('dates');
    const timesEl = document.getElementById('times');
    const nextPrayerEl = document.getElementById('next-prayer');
    const currentLocationEl = document.getElementById('current-location');
    const qiblaDegreesEl = document.getElementById('qibla-degrees');
    const distanceInfoEl = document.getElementById('distance-info');
    const compassArrowEl = document.getElementById('compass-arrow');
    const kaabaMarkerEl = document.getElementById('kaaba-marker');

    // Initialize
    function init() {
      loadSettings();
      updateClock();
      setInterval(updateClock, 1000);
      updateSavedLocationsDropdown();
      
      if (!localStorage.getItem('savedLocations')) {
        fetchPrayerTimes('Mecca', 'Saudi Arabia');
      }
    }

    // Clock
    function updateClock() {
      clockEl.textContent = new Date().toLocaleTimeString();
      if (currentLocation.timings) updateNextPrayer();
    }

    // Prayer Times
    function fetchPrayerTimes(city, country, latitude, longitude) {
      const method = 2;
      const school = localStorage.getItem('asrMethod') === 'hanafi' ? 1 : 0;
      const url = latitude && longitude 
        ? `https://api.aladhan.com/v1/timings?latitude=${latitude}&longitude=${longitude}&method=${method}&school=${school}`
        : `https://api.aladhan.com/v1/timingsByCity?city=${city}&country=${country}&method=${method}&school=${school}`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          const times = data.data.timings;
          const hijri = data.data.date.hijri;
          const gregorian = data.data.date.gregorian;
          
          datesEl.innerHTML = `${gregorian.date} | ${hijri.date} (${hijri.weekday.en})`;
          timesEl.innerHTML = `<h2>${city}, ${country}</h2>`;
          
          Object.entries(prayerIcons).forEach(([name, icon]) => {
            const row = document.createElement('div');
            row.className = 'time-row';
            row.innerHTML = `
              <span class="time-label"><span class="icon">${icon}</span>${name}</span>
              <span>${to12Hour(times[name])}</span>
            `;
            timesEl.appendChild(row);
          });

          currentLocation = { city, country, latitude, longitude, timings: times };
          updateBackground(Object.keys(prayerIcons), times);
          
          if (latitude && longitude) {
            calculateQiblaDirection(latitude, longitude);
            calculateDistance(latitude, longitude);
          }
        })
        .catch(err => {
          timesEl.innerHTML = 'Failed to fetch prayer times.';
          console.error(err);
        });
    }

    // Qibla Direction
    function calculateQiblaDirection(lat, lng) {
      const phiK = KAABA_LAT * Math.PI / 180;
      const lambdaK = KAABA_LNG * Math.PI / 180;
      const phi = lat * Math.PI / 180;
      const lambda = lng * Math.PI / 180;
      
      const psi = 180 / Math.PI * Math.atan2(
        Math.sin(lambdaK - lambda),
        Math.cos(phi) * Math.tan(phiK) - Math.sin(phi) * Math.cos(lambdaK - lambda)
      );
      
      currentQiblaDirection = (psi + 360) % 360;
      currentLocationEl.textContent = `${currentLocation.city}, ${currentLocation.country}`;
      qiblaDegreesEl.textContent = `${currentQiblaDirection.toFixed(1)}¬∞`;
      updateCompass();
    }

    function calculateDistance(lat, lng) {
      const R = 6371;
      const dLat = (KAABA_LAT - lat) * Math.PI / 180;
      const dLon = (KAABA_LNG - lng) * Math.PI / 180;
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat * Math.PI / 180) * Math.cos(KAABA_LAT * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      distanceToKaaba = R * c;
      distanceInfoEl.textContent = `Distance to Kaaba: ${distanceToKaaba.toFixed(0)} km`;
    }

    // Compass
    function updateCompass() {
      // Position Kaaba marker
      const angle = (360 - currentQiblaDirection) * Math.PI / 180;
      const radius = 125; // Half of compass width
      const kaabaX = radius + (radius - 20) * Math.sin(angle);
      const kaabaY = radius - (radius - 20) * Math.cos(angle);
      
      kaabaMarkerEl.style.left = `${kaabaX}px`;
      kaabaMarkerEl.style.top = `${kaabaY}px`;
      
      // Update compass arrow
      compassArrowEl.style.transform = `translateX(-50%) rotate(${currentQiblaDirection}deg)`;
      
      // Enable device orientation if available
      if (!window.DeviceOrientationEvent) return;
      
      if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
          .then(response => {
            if (response === 'granted') {
              window.addEventListener('deviceorientation', handleOrientation);
            }
          })
          .catch(console.error);
      } else {
        window.addEventListener('deviceorientation', handleOrientation);
      }
    }

    function handleOrientation(event) {
      let heading = 0;
      if (event.absolute && event.webkitCompassHeading) {
        heading = event.webkitCompassHeading; // iOS
      } else if (event.alpha !== null) {
        heading = event.alpha; // Android/other
      }
      
      const arrowAngle = (360 - heading + currentQiblaDirection) % 360;
      compassArrowEl.style.transform = `translateX(-50%) rotate(${arrowAngle}deg)`;
    }

    // Next Prayer
    function updateNextPrayer() {
      const now = new Date();
      const currentTime = now.getHours() * 60 + now.getMinutes();
      let nextPrayer = "Fajr";
      let nextTime = currentLocation.timings.Fajr;
      let minDiff = Infinity;

      Object.entries(currentLocation.timings).forEach(([name, time]) => {
        if (prayerIcons[name]) {
          const [h, m] = time.split(':').map(Number);
          const prayerTime = h * 60 + m;
          const diff = prayerTime - currentTime;
          
          if (diff > 0 && diff < minDiff) {
            minDiff = diff;
            nextPrayer = name;
            nextTime = time;
          }
        }
      });

      if (minDiff === Infinity) {
        minDiff = (24 * 60 - currentTime) + 
                 (parseInt(nextTime.split(':')[0]) * 60 + parseInt(nextTime.split(':')[1]));
      }

      const hours = Math.floor(minDiff / 60);
      const mins = minDiff % 60;
      nextPrayerEl.innerHTML = `Next: ${nextPrayer} at ${to12Hour(nextTime)} (in ${hours > 0 ? hours + 'h ' : ''}${mins}m)`;
    }

    // Background
    function updateBackground(prayers, times) {
      const now = new Date();
      const currentTime = now.getHours() * 60 + now.getMinutes();
      let activePrayer = prayers[0];

      prayers.forEach(prayer => {
        const [h, m] = times[prayer].split(':').map(Number);
        if ((h * 60 + m) <= currentTime) activePrayer = prayer;
      });

      const gradients = {
        "Fajr": "#1e3c72, #2a5298",
        "Sunrise": "#f6d365, #fda085",
        "Dhuhr": "#56ccf2, #2f80ed",
        "Asr": "#f2994a, #f2c94c",
        "Maghrib": "#e96443, #904e95",
        "Isha": "#141e30, #243b55"
      };
      
      document.body.style.background = `linear-gradient(to top, ${gradients[activePrayer]})`;
    }

    // Location
    function searchLocation() {
      const city = document.getElementById('city').value.trim();
      const country = document.getElementById('country').value.trim();
      if (!city || !country) return alert('Please enter city and country');

      fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1`)
        .then(res => res.json())
        .then(data => {
          if (data.results?.length > 0) {
            const { latitude, longitude } = data.results[0];
            saveLocation(city, country, latitude, longitude);
            fetchPrayerTimes(city, country, latitude, longitude);
          } else {
            saveLocation(city, country);
            fetchPrayerTimes(city, country);
          }
        })
        .catch(() => {
          saveLocation(city, country);
          fetchPrayerTimes(city, country);
        });
    }

    function detectLocation() {
      if (!navigator.geolocation) return alert('Geolocation not supported');

      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=en`)
          .then(res => res.json())
          .then(data => {
            const city = data.city || data.locality || "Unknown";
            const country = data.countryCode || "US";
            document.getElementById('city').value = city;
            document.getElementById('country').value = country;
            saveLocation(city, country, latitude, longitude);
            fetchPrayerTimes(city, country, latitude, longitude);
          })
          .catch(console.error);
      }, alert);
    }

    function saveLocation(city, country, latitude, longitude) {
      const saved = JSON.parse(localStorage.getItem('savedLocations') || []);
      if (!saved.some(loc => loc.city === city && loc.country === country)) {
        saved.push({ city, country, latitude, longitude });
        localStorage.setItem('savedLocations', JSON.stringify(saved));
        updateSavedLocationsDropdown();
      }
    }

    function loadSavedLocation(val) {
      if (!val) return;
      const { city, country, latitude, longitude } = JSON.parse(val);
      fetchPrayerTimes(city, country, latitude, longitude);
    }

    function updateSavedLocationsDropdown() {
      const dropdown = document.getElementById('savedLocations');
      dropdown.innerHTML = '<option value="">Saved Locations</option>';
      const saved = JSON.parse(localStorage.getItem('savedLocations') || '[]');
      saved.forEach(loc => {
        const opt = document.createElement('option');
        opt.value = JSON.stringify(loc);
        opt.textContent = `${loc.city}, ${loc.country}`;
        dropdown.appendChild(opt);
      });
    }

    // Settings
    function saveSettings() {
      const asrMethod = document.querySelector('input[name="asr-method"]:checked').value;
      const darkMode = document.getElementById('dark-mode-toggle').checked;
      
      localStorage.setItem('asrMethod', asrMethod);
      localStorage.setItem('darkMode', darkMode);
      document.body.classList.toggle('dark-mode', darkMode);
      
      if (currentLocation.city) {
        const { city, country, latitude, longitude } = currentLocation;
        fetchPrayerTimes(city, country, latitude, longitude);
      }
      
      alert('Settings saved!');
    }

    function loadSettings() {
      const asrMethod = localStorage.getItem('asrMethod') || 'standard';
      const darkMode = localStorage.getItem('darkMode') === 'true';
      
      document.getElementById(`${asrMethod}-asr`).checked = true;
      document.getElementById('dark-mode-toggle').checked = darkMode;
      document.body.classList.toggle('dark-mode', darkMode);
    }

    // Helpers
    function to12Hour(time24) {
      const [h, m] = time24.split(':');
      const hour = parseInt(h) % 12 || 12;
      const ampm = parseInt(h) >= 12 ? 'PM' : 'AM';
      return `${hour}:${m} ${ampm}`;
    }

    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('[id$="-tab"]').forEach(t => t.classList.add('hidden'));
      
      document.querySelector(`.tab[onclick="showTab('${tabName}')"]`).classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.remove('hidden');
      
      if (tabName === 'qibla' && currentLocation.latitude) {
        updateCompass();
      }
    }

    // Start the app
    init();
  </script>
</body>
</html>